---
title: "DATA 698: Final Project"
output: html_document
date: '2022-03-25'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)

```

```{r, load-ade-csv}
ade_csv <- read_tsv('NY_ADE_2018_admit.csv', col_types = 'nnnnnfnnnnnnnnfffnfcccnffffffffffffffffffffffffffffffffffffffnfcnccccccccccccccccccccccccccccccccccccccnnccccccccccccccccccccccccccnnnfffnccfnffffffffffffffffffffffffffffffffffffffffffffffffffcnnffnnfffnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnnncf', col_names = TRUE)
ade_csv <- ade_csv %>% 
  mutate(BP_DIASTOLIC_X = na_if(BP_DIASTOLIC_X, 0)) %>% #remove missing values
  mutate(BP_SYSTOLIC_X = na_if(BP_SYSTOLIC_X, 0)) %>% #remove missin values
  filter(AGE >= 18) %>% #adult patients
  mutate(PSTCO = na_if(PSTCO, '')) #generate missing values for missing codes
  
ade_csv$BP_DIASTOLIC_X[ade_csv$BP_DIASTOLIC_X > 200] <- 70 #remove outliers
ade_csv$BP_DIASTOLIC_X[ade_csv$BP_DIASTOLIC_X > ade_csv$BP_SYSTOLIC_X] <- mean(ade_csv$BP_DIASTOLIC_X, na.rm = TRUE) #remove values that don't make sense
ade_csv$BP_SYSTOLIC_X[ade_csv$BP_DIASTOLIC_X > ade_csv$BP_SYSTOLIC_X] <- mean(ade_csv$BP_SYSTOLIC_X, na.rm = TRUE) #remove values that don't make sense

ade_csv <- ade_csv %>%
  select(-(PRMONTH1:PRYEAR25)) #remove extra rows

```

```{r, remove-duplicates}
#duplicate rows are present for patients with more than one ADE ICD code
#below code will remove duplicate rows and ICD codes, instead providing number of ADE codes

ade_csv <- ade_csv %>%
  group_by(KEY) %>%
  mutate(n_ades = n()) %>%
  ungroup() %>%
  select(-c(Code, Description)) %>%
  unique()

```


```{r, top-10-ade}

ade_counts <- ade_csv %>%
  group_by(Code, Description) %>%
  summarize(n_icd = n()) %>%
  left_join(icd, c('Code' = 'V3')) %>%
  arrange(desc(n_icd)) %>%
  mutate(Description = fct_relevel(Description, c('Category A1','Category A2', 'Category B2', 'Category C')))

ade_counts %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(V5, n_icd))) +
  geom_col(aes(y = n_icd/1000, fill = Description)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 40)) +
  theme(legend.position = c(0.75,0.25)) +
  labs(title = 'Top 10 Most Common ADE\'s, 2018') +
  scale_y_continuous(name = 'Cases, in thousands') +
  coord_flip() 

```


```{r, top-10-ade-cat-ab}

ade_counts2 <- ade_csv %>%
  filter(Description != 'Category C') %>%
  group_by(Code, Description) %>%
  summarize(n_icd = n()) %>%
  left_join(icd, c('Code' = 'V3')) %>%
  arrange(desc(n_icd)) %>%
  mutate(Description = fct_relevel(Description, c('Category A1','Category A2', 'Category B2', 'Category C')))

ade_counts2 %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(V5, n_icd))) +
  geom_col(aes(y = n_icd/1000, fill = Description)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 40)) +
  theme(legend.position = c(0.75,0.25)) +
  labs(title = 'Most Common Category \'A\' drug reactions') +
  scale_y_continuous(name = 'Cases, in thousands') +
  coord_flip() 




```


```{r, n-Diagnoses}

ggplot(ade_csv, aes(I10_NDX)) + #anomaly in the number of diagnoses
  geom_bar() +
  geom_vline(xintercept = 25) +
  labs(x = 'Number of ICD Diagnoses per Patient', y = 'Count', title = 'Unexpected Mode for ICD Diagnoses')

```

```{r, load-other-dfs}


icd <- read.csv('https://raw.githubusercontent.com/k4m1113/ICD-10-CSV/master/codes.csv', header =  FALSE) #icd10 diagnosis codes

#i10_procedure <- read.csv("i10_procedure.csv", stringsAsFactors = TRUE) #icd 10 procedure codes

charge_codes <- read.csv('revcodes.csv')

#NY_FIPS <- read.csv('NY_Municipalities_and_County_FIPS_codes.csv')
#NY_FIPS$County.FIPS[NY_FIPS$County.Name == 'St Lawrence'] <- 36089
#NY_FIPS$County.FIPS <- as.factor(NY_FIPS$County.FIPS)


```

```{r, icd-dx-cats}


icd <- icd %>% #recoded icd csv with icd dx categories
  mutate(icd_cat = case_when(substr(V1,1,1) == "A" | substr(V1,1,1) == "B" ~ 'Certain infections and parasitic diseases',
                             substr(V1,1,1) == "C" ~ 'Neoplasms',
                             substr(V1,1,1) == "D" ~ 'Diseases of the blood and blood-forming organ',
                              substr(V1,1,1) == "E" ~ 'Endocrine, nutritional and metabolic diseases',
                              substr(V1,1,1) == "F" ~ 'Mental, Behavioral and Neurodevelopmental disorders',
                              substr(V1,1,1) == "G" ~ 'Diseases of the nervous system',
                              substr(V1,1,1) == "H" & as.numeric(substr(V1, 2,2)) <=5 ~ 'Diseases of the eye and adnexa',
                              substr(V1,1,1) == "H" & as.numeric(substr(V1, 2,2)) >5 ~ '	Diseases of the ear and mastoid process',
                              substr(V1,1,1) == "I" ~ 'Diseases of the circulatory system',
                              substr(V1,1,1) == "J" ~ 'Diseases of the respiratory system',
                              substr(V1,1,1) == "K" ~ 'Diseases of the digestive system',
                              substr(V1,1,1) == "L" ~ 'Diseases of the skin and subcutaneous tissue',
                              substr(V1,1,1) == "M" ~ 'Diseases of the musculoskeletal system and connective tissue',
                              substr(V1,1,1) == "N" ~ 'Diseases of the genitourinary system',
                              substr(V1,1,1) == "O" ~ 'Pregnancy, childbirth, and puerperium',
                              substr(V1,1,1) == "P" ~ 'Certain conditions originating in the perinatal period',
                              substr(V1,1,1) == "Q" ~ 'Congenital malformations, deformations and chromosomal abnormalities',
                              substr(V1,1,1) == "R" ~ 'Symptoms, signs, and abnormal clinical laboratory findings, not elsewhere classified',
                              substr(V1,1,1) == "S" | substr(V1,1,1) == "T" ~ 'Injury, poisoning, and certain other consequences of external causes',
                              substr(V1,1,1) == "V" | substr(V1,1,1) == "W" | substr(V1,1,1) == "X" | substr(V1,1,1) == "Y" ~ 'External causes of morbidity',
                              substr(V1,1,1) == "Z" ~ 'Factors influencing health status and contact with health services'
                             )
         )

```


```{r, women}

###-Proportion of women (+ SD) 
ade_csv %>%
	summarize(avg_female = mean((FEMALE == 1), na.rm = TRUE))

ade_csv %>%
	summarize(sd_female = sd(as.numeric(FEMALE == 1), na.rm = TRUE))
```
```{r, races}
##-Proportion of races 
ade_csv %>%
	mutate(RACE = recode_factor(RACE, `1`= 'White',
															`2` = 'Black',
															`3` = 'Hispanic',
															`4` = 'AAPI',
															`5` = 'Native American',
															`6` = 'Other/Missing',
															`NA` = 'Other/Missing')) %>%
	group_by(RACE) %>%
	summarize(PCT_RACE = 100*round(n()/nrow(ade_csv),3))
```

```{r, hispanic}
			
##-Proportion Hispanic 

ade_csv %>%
  mutate(HISPANIC = na_if(HISPANIC, '')) %>%
	mutate(HISPANIC = recode_factor(HISPANIC, `0`= 'Not Hispanic',
															`1` = 'Hispanic, White',
															`2` = 'Hispanic, Black',
															`3` = 'Hispanic, Other Race')) %>%
	group_by(HISPANIC) %>%
	summarize(PCT_HISPANIC = 100*round(n()/nrow(ade_csv),3))
  

```
```{r, av-charge}
##-Average charge  
ade_csv %>%
	summarize(avg_charge = mean(TOTCHG_X, na.rm = TRUE))

ggplot(ade_csv, aes(x = TOTCHG_X)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10', labels = scales::dollar_format()) +
  labs(x = 'Total Charges per Visit, log scale', y = 'Count', title = 'Distribution of Charges, Inpatient Stays')


```

```{r, ed-admits}
##-Proportion of ED admissions 

ade_csv %>%
  summarize(PCT_ED = mean(as.numeric(HCUP_ED != 0)))
	          
ade_csv %>%
	summarize(SD_ED = sd(as.numeric(HCUP_ED != 0)))

```
```{r, los}
##-Average LOS 

ade_csv %>%
	summarize(AVG_LOS = mean(LOS_X, na.rm = TRUE))
ade_csv %>%
  summarize(SD_LOS = sd(LOS_X, na.rm = TRUE))


ggplot(ade_csv, aes(x = LOS_X)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10') +
  labs(x = 'Total Length of Stay, log scale', y = 'Count', title = 'Length of Inpatient Stay')

summary(ade_csv$LOS_X)  
ade_csv %>%
  ggplot(aes(x = LOS_X, fill = DIED == 0)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10')

ade_csv %>%
  filter(LOS_X <= 10) %>%
  ggplot(aes(x = LOS_X, fill = DIED == 0)) +
  geom_histogram() +
  scale_x_discrete()
hist(ade_csv$LOS_X[ade_csv$LOS_X < 10])
```	          
```{r, died}	          	
##-Proportion who died 

ade_csv %>%
	summarize(PCT_DIED = mean(DIED, na.rm = TRUE))

ade_csv %>%
  summarize(sd_died = sd(DIED, na.rm = TRUE))

	          
```
```{r, cost-per-day}      
##-Average cost per day 
ade_cost <- ade_csv 
ade_cost$LOS_X[ade_cost$LOS_X == 0] <- 1
ade_cost <- ade_cost %>%
  filter(!is.na(LOS_X), !is.na(TOTCHG_X)) %>%
		mutate(cost_per_day = round(TOTCHG_X/LOS_X, 2))
ade_cost %>%
    summarize(avg_cost_per_day = round(mean(cost_per_day, na.rm = TRUE),2))

ade_cost %>%
		mutate(cost_per_day = round(TOTCHG_X/LOS_X, 2)) %>% 
		summarize(sd_daily_cost = sd(cost_per_day, na.rm = TRUE))

ade_cost %>%
  ggplot(aes(x = cost_per_day)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10', labels = scales:: dollar_format()) +
  labs(x = 'Average cost per day of Hospital Admission, USD', y = 'Count', title = 'Average Cost Per day of Inpatient Visit')
```

						
##-Most common procedures 
##-Map of NY 
##-Breakdown of Patients by Region 
##-Bivariate choropleth map of admissions versus ade's
							

```{r, load-json}
nycounties <- rgdal::readOGR('https://raw.githubusercontent.com/hillt5/DATA608/main/Final%20Project/gz_2010_us_050_00_20m.json')
nycounties <- nycounties[nycounties$STATE == 36,]
```



###ade's versus num of admissions

```{r, choropleth-map}
choropleth_counties <- county_bd_births_0914 %>%
  mutate(map_color = case_when(
    ade_per_capita < 6.413 & defects_per_capita < 0.2242 ~ 'Low-Low',
    births_per_capita < 6.413 & (defects_per_capita > 0.2242 & defects_per_capita < 0.3238) ~ 'Low-Med',
    births_per_capita < 6.413 & defects_per_capita > 0.3238 ~ 'Low-High',
    (births_per_capita > 6.413 & births_per_capita < 12) & defects_per_capita < 0.2242 ~ 'Med-Low',
    (births_per_capita > 6.413 & births_per_capita < 12) & (defects_per_capita > 0.2242 & defects_per_capita < 0.3238) ~ 'Med-Med',
    (births_per_capita > 6.413 & births_per_capita < 12) & defects_per_capita > 0.3238 ~ 'Med-High',
    births_per_capita > 12 & defects_per_capita < 0.2242 ~ 'High-Low',
    births_per_capita > 12 & (defects_per_capita > 0.2242 & defects_per_capita < 0.3238) ~ 'High-Med',
    births_per_capita > 12 & defects_per_capita > 0.3238 ~ 'High-High'
  ))
choropleth_counties$map_color <- factor(choropleth_counties$map_color, ordered = TRUE, levels = c('Low-Low', 'Med-Low', 'High-Low', 'Low-Med', 'Med-Med', 'High-Med', 'Low-High', 'Med-High', 'High-High'))
factpal <- colorFactor(pals::stevens.bluered(n= 9), domain = rev(choropleth_counties$map_color))
leaflet(nycounties) %>%
  addPolygons(fillColor = ~factpal(choropleth_counties$map_color), fillOpacity = 1, weight = 1, opacity = 1, color = 'white', popup = ~nycounties$NAME) %>%
  addProviderTiles(providers$CartoDB.DarkMatter) %>%
  addLegend(pal = factpal, values = ~choropleth_counties$map_color, title = 'Per admission ADE Rate versus Inpatient Hospitalizations, New York State 2018')
```
			
	
#### Demographics (for ADE) 
##-Age (+ SD) 
##-Proportion of women (+ SD) 
##-Proportion of races (+ SD) 
##-Proportion Hispanic (+SD) 
##-Average charge  
##-Average LOS 
##-Average cost per day 
##-Most common diagnoses 
##Most common admitting diagnosis

```{r, dx-admitting} 
ade_csv %>% #most common ADEs
  group_by(Code) %>%
  summarize(n_pt = n()) %>%
  arrange(desc(n_pt))


ade_admitting <- ade_csv %>% #most common ADEs, admitting only
  dplyr::select(I10_DX_Admitting) %>%
  group_by(I10_DX_Admitting) %>%
  summarize(n_patients = n()) %>%
  arrange(desc(n_patients)) %>%
  head(10) %>%
  left_join(icd, c('I10_DX_Admitting' = 'V3')) %>%
  select(V5, n_patients)

ggplot(ade_admitting, aes(x = fct_reorder(V5, n_patients), y = n_patients)) +
  geom_col() +
  coord_flip()
```
##-Most common procedures 



```{r, top-10-procedures}

i10_procedure <- read.csv('i10_procedure.csv')


proc_counts <- ade_csv %>% #use similar code to determine most common procedures
  dplyr:: select(I10_PR1:I10_PR25) %>%
  gather(dx_num, Code, I10_PR1:I10_PR25,factor_key = TRUE ) %>%
  mutate(Code = as.factor(Code)) %>%
  group_by(Code) %>%
  summarize(n_patients = n()) %>%
  mutate(Code = na_if(Code, ' ')) %>%
  drop_na() %>%
  arrange(desc(n_patients)) %>%
  inner_join(i10_procedure, by = c('Code' = 'ICD.10.PCS.CODE'))  %>% #join with i10 procedure text csv
  dplyr :: select(ICD.10.PCS.CODE.DESCRIPTION, n_patients, Code)


proc_counts %>%
  arrange(desc(n_patients)) %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(ICD.10.PCS.CODE.DESCRIPTION, n_patients))) +
  geom_col(aes(y = n_patients/1000)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "), width = 55)) +
  theme(legend.position = c(0.75,0.25)) +
  labs(title = 'Top 10 Most Common Procedures, 2018') +
  scale_y_continuous(name = 'Procedure ClLaims, in thousands') +
  coord_flip() 


```

```{r, n-Diagnoses}

ggplot(ade_csv, aes(I10_NPR)) + #anomaly in the number of diagnoses
  geom_bar()

```






