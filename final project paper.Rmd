---
title: 'Adverse Drug Events in New York Hospitals: Prediction and Associated Costs'
author:
  - name: Thomas Hill
    email: thomas.hill82@spsmail.cuny.edu
    affiliation: CUNY School of Profesional Services
    correspondingauthor: true
    footnote: 1
keywords: 
  - Data Science
  - Adverse Drug Event
journal: "DATA 698"
date: "`May 17, 2022"
classoption: preprint, 3p, authoryear
bibliography: mybibfile.bib
linenumbers: false
numbersections: true
# Use a CSL with `citation_package = "default"`
# csl: https://www.zotero.org/styles/elsevier-harvard
output: 
  rticles::elsevier_article:
    keep_tex: true
    citation_package: natbib
---


```{r setup, include=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)


```


```{r load-csv, echo= FALSE, message = FALSE}

ade_flag <- read_csv('core_paper_vars')

```




```{r, top-10-ade}

icd <- read.csv('https://raw.githubusercontent.com/k4m1113/ICD-10-CSV/master/codes.csv', header =  FALSE) #icd10 diagnosis codes

ade_counts <- ade_flag %>%
  filter(has_ade == 1) %>%
  group_by(Code, Description) %>%
  summarize(n_icd = n()) %>%
  left_join(icd, c('Code' = 'V3')) %>%
  arrange(desc(n_icd)) %>%
  mutate(Description = fct_relevel(Description, c('Category A1','Category A2', 'Category B2', 'Category C')))

ade_counts %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(V5, n_icd))) +
  geom_col(aes(y = n_icd/1000, fill = Description)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 40)) +
  theme(legend.position = c(0.75,0.25)) +
  labs(title = 'Top 10 Most Common ADE\'s, 2018') +
  scale_y_continuous(name = 'Cases, in thousands') +
  coord_flip() 

```


```{r, top-10-ade-cat-ab}

ade_counts2 <- ade_flag %>%
  filter(has_ade == 1) %>%
  filter(Description != 'Category C') %>%
  group_by(Code, Description) %>%
  summarize(n_icd = n()) %>%
  left_join(icd, c('Code' = 'V3')) %>%
  arrange(desc(n_icd)) %>%
  mutate(Description = fct_relevel(Description, c('Category A1','Category A2', 'Category B2', 'Category C')))

ade_counts2 %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(V5, n_icd))) +
  geom_col(aes(y = n_icd/1000, fill = Description)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 40)) +
  theme(legend.position = c(0.75,0.25)) +
  labs(title = 'Most Common Category \'A\' drug reactions') +
  scale_y_continuous(name = 'Cases, in thousands') +
  coord_flip() 

ade_counts2 %>%
  filter(Description == 'Category B2') %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(V5, n_icd))) +
  geom_col(aes(y = n_icd)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 35)) +
  labs(title = 'Most Common Category \'B\' drug reactions') +
  scale_y_continuous(name = 'Cases') +
  coord_flip() 



ade_counts %>%
  filter(Description == 'Category C') %>%
  head(3) %>%
  ggplot(aes(x = fct_reorder(V5, n_icd))) +
  geom_col(aes(y = n_icd/1000)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "),
                                                 width = 35)) +
  labs(title = 'Most Common Category \'C\' drug reactions') +
  scale_y_continuous(name = 'Cases, in thousands') +
  coord_flip() 



```

```{r, women}

###-Proportion of women (+ SD) 
ade_flag %>%
	summarize(avg_female = mean((FEMALE == 1), na.rm = TRUE))

ade_flag %>%
	summarize(sd_female = sd(as.numeric(FEMALE == 1), na.rm = TRUE))
```
```{r, races}
##-Proportion of races 
ade_flag %>%
	mutate(RACE = recode_factor(RACE, `1`= 'White',
															`2` = 'Black',
															`3` = 'Hispanic',
															`4` = 'AAPI',
															`5` = 'Native American',
															`6` = 'Other/Missing',
															`NA` = 'Other/Missing')) %>%
	group_by(RACE) %>%
	summarize(PCT_RACE = 100*round(n()/nrow(ade_flag),3))
```

```{r, hispanic}
			
##-Proportion Hispanic 

ade_flag %>%
  mutate(HISPANIC = na_if(HISPANIC, '')) %>%
	mutate(HISPANIC = recode_factor(HISPANIC, `0`= 'Not Hispanic',
															`1` = 'Hispanic, White',
															`2` = 'Hispanic, Black',
															`3` = 'Hispanic, Other Race')) %>%
	group_by(HISPANIC) %>%
	summarize(PCT_HISPANIC = 100*round(n()/nrow(ade_flag),3))
  
ade_flag %>%
  filter(has_ade == 1) %>%
  mutate(HISPANIC = na_if(HISPANIC, '')) %>%
	mutate(HISPANIC = recode_factor(HISPANIC, `0`= 'Not Hispanic',
															`1` = 'Hispanic, White',
															`2` = 'Hispanic, Black',
															`3` = 'Hispanic, Other Race')) %>%
	group_by(HISPANIC) %>%
	summarize(PCT_HISPANIC = 100*round(n()/nrow(ade_flag),3))
  

```
```{r, av-charge}
##-Average charge  
ade_flag %>%
	summarize(avg_charge = mean(TOTCHG_X, na.rm = TRUE))

ggplot(ade_flag, aes(x = TOTCHG_X)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10', labels = scales::dollar_format()) +
  labs(x = 'Total Charges per Visit, log scale', y = 'Count', title = 'Distribution of Charges, Inpatient Stays')


```

```{r, ed-admits}
##-Proportion of ED admissions 

ade_flag %>%
  summarize(PCT_ED = mean(as.numeric(HCUP_ED != 0)))
	          
ade_flag %>%
	summarize(SD_ED = sd(as.numeric(HCUP_ED != 0)))

```
```{r, los}
##-Average LOS 

ade_flag %>%
	summarize(AVG_LOS = mean(LOS_X, na.rm = TRUE))
ade_flag %>%
  summarize(SD_LOS = sd(LOS_X, na.rm = TRUE))


ggplot(ade_flag, aes(x = LOS_X)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10') +
  labs(x = 'Total Length of Stay, log scale', y = 'Count', title = 'Length of Inpatient Stay')

summary(ade_flag$LOS_X)  
ade_flag %>%
  ggplot(aes(x = LOS_X, fill = DIED == 0)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10')

ade_flag %>%
  filter(LOS_X <= 10) %>%
  ggplot(aes(x = LOS_X, fill = DIED == 0)) +
  geom_histogram() +
  scale_x_discrete()
hist(ade_flag$LOS_X[ade_flag$LOS_X < 10])
```	          
```{r, died}	          	
##-Proportion who died 

ade_flag %>%
	summarize(PCT_DIED = mean(DIED, na.rm = TRUE))

ade_flag %>%
  summarize(sd_died = sd(DIED, na.rm = TRUE))

	          
```
```{r, cost-per-day}      
##-Average cost per day 
ade_cost <- ade_flag 
ade_cost$LOS_X[ade_cost$LOS_X == 0] <- 1
ade_cost <- ade_cost %>%
  filter(!is.na(LOS_X), !is.na(TOTCHG_X)) %>%
		mutate(cost_per_day = round(TOTCHG_X/LOS_X, 2))
ade_cost %>%
    summarize(avg_cost_per_day = round(mean(cost_per_day, na.rm = TRUE),2))

ade_cost %>%
		mutate(cost_per_day = round(TOTCHG_X/LOS_X, 2)) %>% 
		summarize(sd_daily_cost = sd(cost_per_day, na.rm = TRUE))

ade_cost %>%
  ggplot(aes(x = cost_per_day)) +
  geom_histogram() +
  scale_x_continuous(trans = 'log10', labels = scales:: dollar_format()) +
  labs(x = 'Average cost per day of Hospital Admission, USD', y = 'Count', title = 'Average Cost Per day of Inpatient Visit')
```

						
##-Most common procedures 
##-Map of NY 
##-Breakdown of Patients by Region 
##-Bivariate choropleth map of admissions versus ade's
							

```{r, load-json}
nycounties <- rgdal::readOGR('https://raw.githubusercontent.com/hillt5/DATA608/main/Final%20Project/gz_2010_us_050_00_20m.json')
nycounties <- nycounties[nycounties$STATE == 36,]
```



###ade's versus num of admissions

```{r, choropleth-map}
choropleth_counties <- county_bd_births_0914 %>%
  mutate(map_color = case_when(
    ade_per_capita < 6.413 & defects_per_capita < 0.2242 ~ 'Low-Low',
    births_per_capita < 6.413 & (defects_per_capita > 0.2242 & defects_per_capita < 0.3238) ~ 'Low-Med',
    births_per_capita < 6.413 & defects_per_capita > 0.3238 ~ 'Low-High',
    (births_per_capita > 6.413 & births_per_capita < 12) & defects_per_capita < 0.2242 ~ 'Med-Low',
    (births_per_capita > 6.413 & births_per_capita < 12) & (defects_per_capita > 0.2242 & defects_per_capita < 0.3238) ~ 'Med-Med',
    (births_per_capita > 6.413 & births_per_capita < 12) & defects_per_capita > 0.3238 ~ 'Med-High',
    births_per_capita > 12 & defects_per_capita < 0.2242 ~ 'High-Low',
    births_per_capita > 12 & (defects_per_capita > 0.2242 & defects_per_capita < 0.3238) ~ 'High-Med',
    births_per_capita > 12 & defects_per_capita > 0.3238 ~ 'High-High'
  ))
choropleth_counties$map_color <- factor(choropleth_counties$map_color, ordered = TRUE, levels = c('Low-Low', 'Med-Low', 'High-Low', 'Low-Med', 'Med-Med', 'High-Med', 'Low-High', 'Med-High', 'High-High'))
factpal <- colorFactor(pals::stevens.bluered(n= 9), domain = rev(choropleth_counties$map_color))
leaflet(nycounties) %>%
  addPolygons(fillColor = ~factpal(choropleth_counties$map_color), fillOpacity = 1, weight = 1, opacity = 1, color = 'white', popup = ~nycounties$NAME) %>%
  addProviderTiles(providers$CartoDB.DarkMatter) %>%
  addLegend(pal = factpal, values = ~choropleth_counties$map_color, title = 'Per admission ADE Rate versus Inpatient Hospitalizations, New York State 2018')
```
			
	
#### Demographics (for ADE) 
##-Age (+ SD) 
##-Proportion of women (+ SD) 
##-Proportion of races (+ SD) 
##-Proportion Hispanic (+SD) 
##-Average charge  
##-Average LOS 
##-Average cost per day 
##-Most common diagnoses 
##Most common admitting diagnosis

```{r, dx-admitting} 
ade_flag %>% #most common ADEs
  group_by(Code) %>%
  summarize(n_pt = n()) %>%
  arrange(desc(n_pt))


ade_admitting <- ade_flag %>% #most common ADEs, admitting only
  dplyr::select(I10_DX_Admitting) %>%
  group_by(I10_DX_Admitting) %>%
  summarize(n_patients = n()) %>%
  arrange(desc(n_patients)) %>%
  head(10) %>%
  left_join(icd, c('I10_DX_Admitting' = 'V3')) %>%
  select(V5, n_patients)

ggplot(ade_admitting, aes(x = fct_reorder(V5, n_patients), y = n_patients)) +
  geom_col() +
  coord_flip()
```
##-Most common procedures 


```{r, n-procedures}

ggplot(ade_flag, aes(I10_NPR)) + #anomaly in the number of procedures
  geom_bar()

```



```{r, top-10-procedures}

i10_procedure <- read.csv('i10_procedure.csv')


proc_counts <- ade_flag %>% #use similar code to determine most common procedures
  dplyr:: select(I10_PR1:I10_PR25) %>%
  gather(dx_num, Code, I10_PR1:I10_PR25,factor_key = TRUE ) %>%
  mutate(Code = as.factor(Code)) %>%
  group_by(Code) %>%
  summarize(n_patients = n()) %>%
  mutate(Code = na_if(Code, ' ')) %>%
  drop_na() %>%
  arrange(desc(n_patients)) %>%
  inner_join(i10_procedure, by = c('Code' = 'ICD.10.PCS.CODE'))  %>% #join with i10 procedure text csv
  dplyr :: select(ICD.10.PCS.CODE.DESCRIPTION, n_patients, Code)


proc_counts %>%
  arrange(desc(n_patients)) %>%
  head(10) %>%
  ggplot(aes(x = fct_reorder(ICD.10.PCS.CODE.DESCRIPTION, n_patients))) +
  geom_col(aes(y = n_patients/1000)) + 
  scale_x_discrete(name = 'ICD Description', labels = function(x) str_wrap(str_replace_all(x, "foo" , " "), width = 55)) +
  theme(legend.position = c(0.75,0.25)) +
  labs(title = 'Top 10 Most Common Procedures, 2018') +
  scale_y_continuous(name = 'Procedure ClLaims, in thousands') +
  coord_flip() 


```



